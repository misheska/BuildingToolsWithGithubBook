                                                                                Activities API Overview


   ...
   exports.prHandler = ( robot, req, res ) ->
            body = req.body
            pr = JSON.parse body if body

            url = pr.pull_request.html_url if pr
            secret = pr.secret if pr

            if secret == _SECRET and url
                    room = "general"

   ...

   Here you see we pull out the body contents, process them as JSON, extract

the secret and the URL from the parsed JSON, and then go through our normal
routine.

   Our tests are simple, and require that we send in JSON.

   ...

   it "should disallow calls without the secret and url", (done) ->
            req = {}
            Handler.prHandler( robot, req, res )
            expect( robot.messageRoom ).not.toHaveBeenCalled()
            expect( httpSpy ).not.toHaveBeenCalled()

            expect( res.send ).toHaveBeenCalled()
          done()

   it "should allow calls with the secret and url", (done) ->
            req = { body: '{ "pull_request" : { "html_url" : "http://pr/1" },

            "secret": "ABCDEF" }' }
            Handler.prHandler( robot, req, res )
            expect( robot.messageRoom ).toHaveBeenCalled()
            expect( httpSpy ).toHaveBeenCalled()

            expect( res.send ).toHaveBeenCalled()
            done()
   ...


   We are putting the secret inside the JSON as a convenience. The secret will
not come in with the JSON when GitHub sends us JSON via the webhook, but
this is an easy way to provide it to our handler for the moment. If we run our

tests, they should pass now.


SECURING THE WEBHOOK


Our Probot is now in a position where it will operate correctly if the secret pass-
es validation and the webhook data is passed properly. Now we need to secure
the webhook. GitHub signs your data inside the webhook payload which pro-

vides you with a way to verify the data really came from an authorized host. We
need to decode it inside our handler. To do this, we will need to retrieve the se-




                                                                                       267